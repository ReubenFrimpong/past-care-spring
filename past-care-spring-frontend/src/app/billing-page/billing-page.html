<div class="billing-page">
  <div class="page-header">
    <h1>Billing & Subscription</h1>
    <p class="subtitle">Manage your subscription and payment information</p>
  </div>

  <!-- Success/Error Messages -->
  @if (successMessage()) {
    <div class="alert alert-success">
      <i class="fas fa-check-circle"></i>
      {{ successMessage() }}
    </div>
  }
  @if (errorMessage()) {
    <div class="alert alert-danger">
      <i class="fas fa-exclamation-circle"></i>
      {{ errorMessage() }}
    </div>
  }

  <!-- Current Subscription Card -->
  <div class="subscription-card card">
    <div class="card-header">
      <h2>Current Subscription</h2>
    </div>
    <div class="card-body">
      @if (isLoadingSubscription()) {
        <div class="loading">Loading subscription...</div>
      } @else if (subscription()) {
        <div class="subscription-info">
          <div class="plan-badge">
            <h3>{{ subscription()!.plan.displayName }}</h3>
            <span class="badge" [class]="getStatusBadgeClass(subscription()!.status)">
              {{ getStatusDisplayText(subscription()!.status) }}
            </span>
          </div>

          <!-- Trial Countdown -->
          @if (subscription()!.status === 'TRIALING' && daysRemainingInTrial()) {
            <div class="trial-countdown">
              <i class="fas fa-clock"></i>
              <strong>{{ daysRemainingInTrial() }}</strong> days remaining in trial
            </div>
          }

          <div class="subscription-details">
            <div class="detail-item">
              <span class="label">Plan Price:</span>
              <span class="value">
                @if (subscription()!.plan.isFree) {
                  Free
                } @else {
                  ${{ subscription()!.plan.price }}/month
                }
              </span>
            </div>

            @if (subscription()!.nextBillingDate) {
              <div class="detail-item">
                <span class="label">Next Billing Date:</span>
                <span class="value">{{ formatDate(subscription()!.nextBillingDate) }}</span>
              </div>
            }

            @if (subscription()!.currentPeriodEnd) {
              <div class="detail-item">
                <span class="label">Current Period Ends:</span>
                <span class="value">{{ formatDate(subscription()!.currentPeriodEnd) }}</span>
              </div>
            }

            @if (subscription()!.cardLast4) {
              <div class="detail-item">
                <span class="label">Payment Method:</span>
                <span class="value">
                  {{ subscription()!.cardBrand }} ending in {{ subscription()!.cardLast4 }}
                </span>
              </div>
            }
          </div>

          <!-- Action Buttons -->
          <div class="subscription-actions">
            @if (subscription()!.status === 'CANCELED') {
              <button class="btn btn-primary" (click)="reactivateSubscription()" [disabled]="isProcessing()">
                <i class="fas fa-redo"></i>
                Reactivate Subscription
              </button>
            } @else if (subscription()!.status === 'ACTIVE' || subscription()!.status === 'TRIALING') {
              @if (!subscription()!.plan.isFree) {
                <button class="btn btn-danger-outline" (click)="showCancelDialog.set(true)">
                  <i class="fas fa-times"></i>
                  Cancel Subscription
                </button>
              }
            }
          </div>
        </div>
      }
    </div>
  </div>

  <!-- Usage Metrics -->
  @if (subscription()) {
    <div class="usage-card card">
      <div class="card-header">
        <h2>Usage Metrics</h2>
      </div>
      <div class="card-body">
        <!-- Storage Usage -->
        <div class="usage-item">
          <div class="usage-header">
            <span class="label">Storage Used</span>
            <span class="value">
              {{ storageUsageMb() }} MB / {{ formatStorageLimit(subscription()!.plan.storageLimitMb) }}
              ({{ storageUsagePercent().toFixed(1) }}%)
            </span>
          </div>
          <div class="progress">
            <div
              class="progress-bar"
              [class]="getStorageProgressClass()"
              [style.width.%]="storageUsagePercent()"
            ></div>
          </div>
          @if (storageUsagePercent() >= 80) {
            <div class="usage-warning">
              <i class="fas fa-exclamation-triangle"></i>
              You're approaching your storage limit. Consider upgrading your plan.
            </div>
          }
        </div>

        <!-- User Usage -->
        <div class="usage-item">
          <div class="usage-header">
            <span class="label">Users</span>
            <span class="value">
              {{ userCount() }}
              @if (hasUnlimitedUsers(subscription()!.plan)) {
                (Unlimited)
              } @else {
                / {{ subscription()!.plan.userLimit }}
                ({{ userUsagePercent().toFixed(1) }}%)
              }
            </span>
          </div>
          @if (!hasUnlimitedUsers(subscription()!.plan)) {
            <div class="progress">
              <div
                class="progress-bar"
                [class]="getUserProgressClass()"
                [style.width.%]="userUsagePercent()"
              ></div>
            </div>
            @if (userUsagePercent() >= 80) {
              <div class="usage-warning">
                <i class="fas fa-exclamation-triangle"></i>
                You're approaching your user limit. Consider upgrading your plan.
              </div>
            }
          }
        </div>
      </div>
    </div>
  }

  <!-- Available Plans -->
  <div class="plans-section">
    <h2>Available Plans</h2>
    @if (shouldShowUpgradePrompt()) {
      <div class="upgrade-prompt">
        <i class="fas fa-arrow-up"></i>
        You're approaching your plan limits. Upgrade to get more storage and users!
      </div>
    }

    @if (isLoadingPlans()) {
      <div class="loading">Loading plans...</div>
    } @else {
      <div class="plans-grid">
        @for (plan of availablePlans(); track plan.id) {
          <div class="plan-card card" [class.current-plan]="isCurrentPlan(plan)">
            <div class="plan-header">
              <h3>{{ plan.displayName }}</h3>
              @if (isCurrentPlan(plan)) {
                <span class="badge badge-primary">Current Plan</span>
              }
            </div>

            <div class="plan-price">
              @if (plan.isFree) {
                <span class="price">Free</span>
              } @else {
                <span class="price">${{ plan.price }}</span>
                <span class="period">/month</span>
              }
            </div>

            <p class="plan-description">{{ plan.description }}</p>

            <ul class="plan-features">
              <li><i class="fas fa-check"></i> {{ formatStorageLimit(plan.storageLimitMb) }} Storage</li>
              <li>
                <i class="fas fa-check"></i>
                @if (hasUnlimitedUsers(plan)) {
                  Unlimited Users
                } @else {
                  Up to {{ plan.userLimit }} Users
                }
              </li>
              @for (feature of plan.features; track feature) {
                <li><i class="fas fa-check"></i> {{ feature }}</li>
              }
            </ul>

            <div class="plan-actions">
              @if (isCurrentPlan(plan)) {
                <button class="btn btn-secondary" disabled>Current Plan</button>
              } @else if (isUpgrade(plan)) {
                <button
                  class="btn btn-primary"
                  (click)="upgradeToPlan(plan)"
                  [disabled]="isProcessing()"
                >
                  Upgrade to {{ plan.displayName }}
                </button>
              } @else if (isDowngrade(plan)) {
                <button class="btn btn-secondary-outline" (click)="showDowngradeDialog.set(true)">
                  Downgrade to {{ plan.displayName }}
                </button>
              } @else if (plan.isFree) {
                <button class="btn btn-secondary-outline" (click)="showDowngradeDialog.set(true)">
                  Switch to Free Plan
                </button>
              }
            </div>
          </div>
        }
      </div>
    }
  </div>

  <!-- Payment History -->
  <div class="payment-history card">
    <div class="card-header">
      <h2>Payment History</h2>
    </div>
    <div class="card-body">
      @if (isLoadingPayments()) {
        <div class="loading">Loading payment history...</div>
      } @else if (payments().length === 0) {
        <p class="no-data">No payment history available.</p>
      } @else {
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Plan</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Payment Method</th>
                <th>Reference</th>
              </tr>
            </thead>
            <tbody>
              @for (payment of payments(); track payment.id) {
                <tr>
                  <td>{{ formatDateTime(payment.paymentDate || payment.createdAt) }}</td>
                  <td>{{ payment.plan.displayName }}</td>
                  <td>{{ formatPaymentAmount(payment) }}</td>
                  <td>
                    <span class="badge" [class]="getPaymentStatusBadgeClass(payment.status)">
                      {{ payment.status }}
                    </span>
                  </td>
                  <td>
                    @if (payment.cardLast4) {
                      {{ payment.cardBrand }} •••• {{ payment.cardLast4 }}
                    } @else {
                      {{ payment.paymentMethod || 'N/A' }}
                    }
                  </td>
                  <td class="reference">{{ payment.paystackReference }}</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      }
    </div>
  </div>

  <!-- Cancel Subscription Dialog -->
  @if (showCancelDialog()) {
    <div class="dialog-overlay" (click)="showCancelDialog.set(false)">
      <div class="dialog" (click)="$event.stopPropagation()">
        <div class="dialog-header">
          <h3>Cancel Subscription</h3>
          <button class="close-btn" (click)="showCancelDialog.set(false)">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="dialog-body">
          <p>Are you sure you want to cancel your subscription?</p>
          <p>Your access will remain active until the end of your current billing period.</p>
        </div>
        <div class="dialog-footer">
          <button class="btn btn-secondary" (click)="showCancelDialog.set(false)" [disabled]="isProcessing()">
            Keep Subscription
          </button>
          <button class="btn btn-danger" (click)="cancelSubscription()" [disabled]="isProcessing()">
            @if (isProcessing()) {
              <i class="fas fa-spinner fa-spin"></i>
              Canceling...
            } @else {
              Cancel Subscription
            }
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Downgrade Dialog -->
  @if (showDowngradeDialog()) {
    <div class="dialog-overlay" (click)="showDowngradeDialog.set(false)">
      <div class="dialog" (click)="$event.stopPropagation()">
        <div class="dialog-header">
          <h3>Downgrade to Free Plan</h3>
          <button class="close-btn" (click)="showDowngradeDialog.set(false)">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="dialog-body">
          <p>Are you sure you want to downgrade to the free plan?</p>
          <p><strong>You will lose access to premium features and reduced storage/user limits.</strong></p>
        </div>
        <div class="dialog-footer">
          <button class="btn btn-secondary" (click)="showDowngradeDialog.set(false)" [disabled]="isProcessing()">
            Cancel
          </button>
          <button class="btn btn-warning" (click)="downgradeToFree()" [disabled]="isProcessing()">
            @if (isProcessing()) {
              <i class="fas fa-spinner fa-spin"></i>
              Downgrading...
            } @else {
              Confirm Downgrade
            }
          </button>
        </div>
      </div>
    </div>
  }
</div>
