<div class="crises-page">
  <p-toast></p-toast>
  <p-confirmDialog></p-confirmDialog>

  <!-- Page Header -->
  <div class="page-header">
    <h1>Crisis Management</h1>
    <p class="subtitle">Report and manage crisis and emergency situations</p>
  </div>

  <!-- Statistics Cards -->
  <div class="stats-grid" *ngIf="stats()">
    <div class="stat-card">
      <div class="stat-icon total">
        <i class="pi pi-exclamation-triangle"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ stats()!.totalCrises }}</div>
        <div class="stat-label">Total Crises</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon active">
        <i class="pi pi-exclamation-circle"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ stats()!.activeCrises }}</div>
        <div class="stat-label">Active</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon in-response">
        <i class="pi pi-bolt"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ stats()!.inResponseCrises }}</div>
        <div class="stat-label">In Response</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon resolved">
        <i class="pi pi-check-circle"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ stats()!.resolvedCrises }}</div>
        <div class="stat-label">Resolved</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon critical">
        <i class="pi pi-shield"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ stats()!.criticalCrises }}</div>
        <div class="stat-label">Critical</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon high-severity">
        <i class="pi pi-flag"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ stats()!.highSeverityCrises }}</div>
        <div class="stat-label">High Severity</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon affected">
        <i class="pi pi-users"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ stats()!.totalAffectedMembers }}</div>
        <div class="stat-label">Affected Members</div>
      </div>
    </div>
  </div>

  <!-- Filters and Actions -->
  <div class="filters-section">
    <div class="filters">
      <span class="p-input-icon-left">
        <i class="pi pi-search"></i>
        <input
          type="text"
          pInputText
          placeholder="Search crises..."
          [(ngModel)]="searchTerm"
          (ngModelChange)="searchTerm.set($event)"
        />
      </span>

      <p-dropdown
        [options]="statusOptions"
        [(ngModel)]="selectedStatus"
        (ngModelChange)="selectedStatus.set($event)"
        placeholder="Filter by Status"
        [showClear]="true"
        optionLabel="label"
        optionValue="value"
      ></p-dropdown>

      <p-dropdown
        [options]="severityOptions"
        [(ngModel)]="selectedSeverity"
        (ngModelChange)="selectedSeverity.set($event)"
        placeholder="Filter by Severity"
        [showClear]="true"
        optionLabel="label"
        optionValue="value"
      ></p-dropdown>

      <p-dropdown
        [options]="typeOptions"
        [(ngModel)]="selectedType"
        (ngModelChange)="selectedType.set($event)"
        placeholder="Filter by Type"
        [showClear]="true"
        optionLabel="label"
        optionValue="value"
      ></p-dropdown>

      <div class="checkbox-filter">
        <p-checkbox
          [(ngModel)]="showOnlyActive"
          (ngModelChange)="showOnlyActive.set($event)"
          [binary]="true"
          inputId="activeOnly"
        ></p-checkbox>
        <label for="activeOnly">Active Only</label>
      </div>

      <div class="checkbox-filter">
        <p-checkbox
          [(ngModel)]="showOnlyCritical"
          (ngModelChange)="showOnlyCritical.set($event)"
          [binary]="true"
          inputId="criticalOnly"
        ></p-checkbox>
        <label for="criticalOnly">Critical Only</label>
      </div>

      <button
        pButton
        type="button"
        label="Clear Filters"
        icon="pi pi-filter-slash"
        class="p-button-secondary p-button-outlined"
        (click)="clearFilters()"
      ></button>
    </div>

    <button
      pButton
      type="button"
      label="Report Crisis"
      icon="pi pi-plus"
      class="p-button-danger"
      (click)="openAddDialog()"
    ></button>
  </div>

  <!-- Crises Grid -->
  <div class="crises-grid" *ngIf="!loading()">
    <p-card *ngFor="let crisis of filteredCrises()" class="crisis-card">
      <div class="card-header">
        <div class="card-title">
          <i class="pi pi-exclamation-triangle"></i>
          <span>{{ crisis.title }}</span>
        </div>
        <div class="card-actions">
          <button
            pButton
            type="button"
            icon="pi pi-eye"
            class="p-button-text p-button-sm"
            (click)="openViewDialog(crisis)"
            pTooltip="View Details"
          ></button>
          <button
            pButton
            type="button"
            icon="pi pi-pencil"
            class="p-button-text p-button-sm"
            (click)="openEditDialog(crisis)"
            pTooltip="Edit"
          ></button>
          <button
            pButton
            type="button"
            icon="pi pi-trash"
            class="p-button-text p-button-sm p-button-danger"
            (click)="deleteCrisis(crisis)"
            pTooltip="Delete"
          ></button>
        </div>
      </div>

      <div class="card-content">
        <div class="info-row" *ngIf="crisis.description">
          <span class="label">Description:</span>
          <span class="value">{{ crisis.description }}</span>
        </div>

        <div class="info-row">
          <span class="label">Type:</span>
          <span class="value">{{ CrisisTypeLabels[crisis.crisisType] }}</span>
        </div>

        <div class="info-row">
          <span class="label">Reported By:</span>
          <span class="value">{{ crisis.reportedByName }}</span>
        </div>

        <div class="info-row">
          <span class="label">Reported Date:</span>
          <span class="value">{{ crisis.reportedDate | date: 'MMM d, y h:mm a' }}</span>
        </div>

        <div class="info-row" *ngIf="crisis.incidentDate">
          <span class="label">Incident Date:</span>
          <span class="value">{{ crisis.incidentDate | date: 'MMM d, y h:mm a' }}</span>
        </div>

        <div class="info-row" *ngIf="crisis.location">
          <span class="label">Location:</span>
          <span class="value">{{ crisis.location }}</span>
        </div>

        <div class="info-row" *ngIf="crisis.affectedMembersCount">
          <span class="label">Affected Members:</span>
          <span class="value">{{ crisis.affectedMembersCount }}</span>
        </div>

        <div class="badges-row">
          <span [class]="'severity-badge ' + getSeverityClass(crisis.severity)">
            {{ CrisisSeverityLabels[crisis.severity] }}
          </span>
          <span [class]="'status-badge ' + getStatusClass(crisis.status)">
            {{ CrisisStatusLabels[crisis.status] }}
          </span>
          <span *ngIf="crisis.resourcesMobilized" class="badge resources">
            <i class="pi pi-inbox"></i> Resources Mobilized
          </span>
          <span *ngIf="crisis.communicationSent" class="badge communication">
            <i class="pi pi-send"></i> Notifications Sent
          </span>
          <span *ngIf="crisis.emergencyContactNotified" class="badge emergency">
            <i class="pi pi-phone"></i> Emergency Contact
          </span>
          <span *ngIf="crisis.followUpRequired" class="badge followup">
            <i class="pi pi-replay"></i> Follow-up Required
          </span>
        </div>

        <div class="action-buttons" *ngIf="!crisis.isResolved">
          <button
            pButton
            type="button"
            label="Mobilize"
            icon="pi pi-inbox"
            class="p-button-warning p-button-sm"
            (click)="openMobilizeDialog(crisis)"
          ></button>
          <button
            pButton
            type="button"
            label="Notify"
            icon="pi pi-send"
            class="p-button-info p-button-sm"
            (click)="sendNotifications(crisis)"
            [disabled]="crisis.communicationSent"
          ></button>
          <button
            pButton
            type="button"
            label="Resolve"
            icon="pi pi-check"
            class="p-button-success p-button-sm"
            (click)="openResolveDialog(crisis)"
          ></button>
          <button
            pButton
            type="button"
            label="Update Status"
            icon="pi pi-refresh"
            class="p-button-secondary p-button-sm"
            (click)="openUpdateStatusDialog(crisis)"
          ></button>
          <button
            pButton
            type="button"
            label="Manage Members"
            icon="pi pi-users"
            class="p-button-help p-button-sm"
            (click)="openManageMembersDialog(crisis)"
          ></button>
        </div>
      </div>
    </p-card>

    <div *ngIf="filteredCrises().length === 0" class="empty-state">
      <i class="pi pi-exclamation-triangle"></i>
      <p>No crises found</p>
      <button
        pButton
        type="button"
        label="Report First Crisis"
        icon="pi pi-plus"
        (click)="openAddDialog()"
      ></button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading()" class="loading-state">
    <i class="pi pi-spin pi-spinner"></i>
    <p>Loading crises...</p>
  </div>

  <!-- Report Crisis Dialog -->
  <p-dialog
    [(visible)]="showAddDialog"
    (visibleChange)="showAddDialog.set($event)"
    [header]="'Report Crisis'"
    [modal]="true"
    [style]="{ width: '700px' }"
  >
    <form [formGroup]="crisisForm">
      <div class="form-grid">
        <div class="form-field full-width">
          <label for="title">Crisis Title *</label>
          <input
            type="text"
            id="title"
            pInputText
            formControlName="title"
            placeholder="Enter crisis title"
          />
        </div>

        <div class="form-field full-width">
          <label for="description">Description</label>
          <textarea
            id="description"
            pInputTextarea
            formControlName="description"
            rows="3"
            placeholder="Describe the crisis situation"
          ></textarea>
        </div>

        <div class="form-field">
          <label for="crisisType">Crisis Type *</label>
          <p-dropdown
            id="crisisType"
            [options]="typeOptions"
            formControlName="crisisType"
            placeholder="Select type"
            optionLabel="label"
            optionValue="value"
          ></p-dropdown>
        </div>

        <div class="form-field">
          <label for="severity">Severity *</label>
          <p-dropdown
            id="severity"
            [options]="severityOptions"
            formControlName="severity"
            placeholder="Select severity"
            optionLabel="label"
            optionValue="value"
          ></p-dropdown>
        </div>

        <div class="form-field">
          <label for="status">Status *</label>
          <p-dropdown
            id="status"
            [options]="statusOptions"
            formControlName="status"
            placeholder="Select status"
            optionLabel="label"
            optionValue="value"
          ></p-dropdown>
        </div>

        <div class="form-field">
          <label for="incidentDate">Incident Date/Time</label>
          <p-calendar
            id="incidentDate"
            formControlName="incidentDate"
            [showIcon]="true"
            [showTime]="true"
            dateFormat="yy-mm-dd"
          ></p-calendar>
        </div>

        <div class="form-field">
          <label for="location">Location</label>
          <input
            type="text"
            id="location"
            pInputText
            formControlName="location"
            placeholder="Enter location"
          />
        </div>

        <div class="form-field">
          <label for="affectedMembersCount">Affected Members Count</label>
          <input
            type="number"
            id="affectedMembersCount"
            pInputText
            formControlName="affectedMembersCount"
            min="0"
          />
        </div>

        <div class="form-field full-width">
          <label for="responseTeamNotes">Response Team Notes</label>
          <textarea
            id="responseTeamNotes"
            pInputTextarea
            formControlName="responseTeamNotes"
            rows="3"
            placeholder="Notes for the response team"
          ></textarea>
        </div>

        <div class="form-field checkbox-field">
          <p-checkbox
            formControlName="followUpRequired"
            [binary]="true"
            inputId="followUpRequired"
          ></p-checkbox>
          <label for="followUpRequired">Requires Follow-up</label>
        </div>

        <div class="form-field" *ngIf="crisisForm.value.followUpRequired">
          <label for="followUpDate">Follow-up Date</label>
          <p-calendar
            id="followUpDate"
            formControlName="followUpDate"
            [showIcon]="true"
            dateFormat="yy-mm-dd"
          ></p-calendar>
        </div>

        <div class="form-field checkbox-field">
          <p-checkbox
            formControlName="communicationSent"
            [binary]="true"
            inputId="communicationSent"
          ></p-checkbox>
          <label for="communicationSent">Communication Sent</label>
        </div>

        <div class="form-field checkbox-field">
          <p-checkbox
            formControlName="emergencyContactNotified"
            [binary]="true"
            inputId="emergencyContactNotified"
          ></p-checkbox>
          <label for="emergencyContactNotified">Emergency Contact Notified</label>
        </div>
      </div>
    </form>

    <ng-template pTemplate="footer">
      <button
        pButton
        type="button"
        label="Cancel"
        icon="pi pi-times"
        class="p-button-secondary"
        (click)="showAddDialog.set(false)"
      ></button>
      <button
        pButton
        type="button"
        label="Report Crisis"
        icon="pi pi-check"
        class="p-button-danger"
        (click)="reportCrisis()"
        [disabled]="crisisForm.invalid"
      ></button>
    </ng-template>
  </p-dialog>

  <!-- Edit Dialog -->
  <p-dialog
    [(visible)]="showEditDialog"
    (visibleChange)="showEditDialog.set($event)"
    [header]="'Edit Crisis'"
    [modal]="true"
    [style]="{ width: '700px' }"
  >
    <form [formGroup]="crisisForm">
      <div class="form-grid">
        <div class="form-field full-width">
          <label for="edit-title">Crisis Title *</label>
          <input
            type="text"
            id="edit-title"
            pInputText
            formControlName="title"
          />
        </div>

        <div class="form-field full-width">
          <label for="edit-description">Description</label>
          <textarea
            id="edit-description"
            pInputTextarea
            formControlName="description"
            rows="3"
          ></textarea>
        </div>

        <div class="form-field">
          <label for="edit-crisisType">Crisis Type *</label>
          <p-dropdown
            id="edit-crisisType"
            [options]="typeOptions"
            formControlName="crisisType"
            optionLabel="label"
            optionValue="value"
          ></p-dropdown>
        </div>

        <div class="form-field">
          <label for="edit-severity">Severity *</label>
          <p-dropdown
            id="edit-severity"
            [options]="severityOptions"
            formControlName="severity"
            optionLabel="label"
            optionValue="value"
          ></p-dropdown>
        </div>

        <div class="form-field">
          <label for="edit-status">Status *</label>
          <p-dropdown
            id="edit-status"
            [options]="statusOptions"
            formControlName="status"
            optionLabel="label"
            optionValue="value"
          ></p-dropdown>
        </div>

        <div class="form-field">
          <label for="edit-location">Location</label>
          <input
            type="text"
            id="edit-location"
            pInputText
            formControlName="location"
          />
        </div>

        <div class="form-field full-width">
          <label for="edit-responseTeamNotes">Response Team Notes</label>
          <textarea
            id="edit-responseTeamNotes"
            pInputTextarea
            formControlName="responseTeamNotes"
            rows="3"
          ></textarea>
        </div>
      </div>
    </form>

    <ng-template pTemplate="footer">
      <button
        pButton
        type="button"
        label="Cancel"
        icon="pi pi-times"
        class="p-button-secondary"
        (click)="showEditDialog.set(false)"
      ></button>
      <button
        pButton
        type="button"
        label="Update"
        icon="pi pi-check"
        (click)="updateCrisis()"
        [disabled]="crisisForm.invalid"
      ></button>
    </ng-template>
  </p-dialog>

  <!-- View Dialog -->
  <p-dialog
    [(visible)]="showViewDialog"
    (visibleChange)="showViewDialog.set($event)"
    [header]="'Crisis Details'"
    [modal]="true"
    [style]="{ width: '700px' }"
  >
    <div *ngIf="selectedCrisis()" class="view-content">
      <div class="detail-row">
        <span class="detail-label">Title:</span>
        <span class="detail-value">{{ selectedCrisis()!.title }}</span>
      </div>

      <div class="detail-row" *ngIf="selectedCrisis()!.description">
        <span class="detail-label">Description:</span>
        <span class="detail-value">{{ selectedCrisis()!.description }}</span>
      </div>

      <div class="detail-row">
        <span class="detail-label">Crisis Type:</span>
        <span class="detail-value">{{ CrisisTypeLabels[selectedCrisis()!.crisisType] }}</span>
      </div>

      <div class="detail-row">
        <span class="detail-label">Severity:</span>
        <span [class]="'severity-badge ' + getSeverityClass(selectedCrisis()!.severity)">
          {{ CrisisSeverityLabels[selectedCrisis()!.severity] }}
        </span>
      </div>

      <div class="detail-row">
        <span class="detail-label">Status:</span>
        <span [class]="'status-badge ' + getStatusClass(selectedCrisis()!.status)">
          {{ CrisisStatusLabels[selectedCrisis()!.status] }}
        </span>
      </div>

      <div class="detail-row">
        <span class="detail-label">Reported By:</span>
        <span class="detail-value">{{ selectedCrisis()!.reportedByName }}</span>
      </div>

      <div class="detail-row">
        <span class="detail-label">Reported Date:</span>
        <span class="detail-value">{{ selectedCrisis()!.reportedDate | date: 'full' }}</span>
      </div>

      <div class="detail-row" *ngIf="selectedCrisis()!.incidentDate">
        <span class="detail-label">Incident Date:</span>
        <span class="detail-value">{{ selectedCrisis()!.incidentDate | date: 'full' }}</span>
      </div>

      <div class="detail-row" *ngIf="selectedCrisis()!.location">
        <span class="detail-label">Location:</span>
        <span class="detail-value">{{ selectedCrisis()!.location }}</span>
      </div>

      <div class="detail-row" *ngIf="selectedCrisis()!.affectedMembersCount">
        <span class="detail-label">Affected Members:</span>
        <span class="detail-value">{{ selectedCrisis()!.affectedMembersCount }}</span>
      </div>

      <div class="detail-row" *ngIf="selectedCrisis()!.responseTeamNotes">
        <span class="detail-label">Response Team Notes:</span>
        <span class="detail-value">{{ selectedCrisis()!.responseTeamNotes }}</span>
      </div>

      <div class="detail-row" *ngIf="selectedCrisis()!.resolutionNotes">
        <span class="detail-label">Resolution Notes:</span>
        <span class="detail-value">{{ selectedCrisis()!.resolutionNotes }}</span>
      </div>

      <div class="detail-row" *ngIf="selectedCrisis()!.resourcesMobilized">
        <span class="detail-label">Resources Mobilized:</span>
        <span class="detail-value">{{ selectedCrisis()!.resourcesMobilized }}</span>
      </div>

      <div class="detail-row" *ngIf="selectedCrisis()!.resolvedDate">
        <span class="detail-label">Resolved Date:</span>
        <span class="detail-value">{{ selectedCrisis()!.resolvedDate | date: 'full' }}</span>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <button
        pButton
        type="button"
        label="Close"
        icon="pi pi-times"
        (click)="showViewDialog.set(false)"
      ></button>
    </ng-template>
  </p-dialog>

  <!-- Mobilize Resources Dialog -->
  <p-dialog
    [(visible)]="showMobilizeDialog"
    (visibleChange)="showMobilizeDialog.set($event)"
    [header]="'Mobilize Resources'"
    [modal]="true"
    [style]="{ width: '500px' }"
  >
    <form [formGroup]="mobilizeForm">
      <div class="form-grid">
        <div class="form-field full-width">
          <label for="resources">Resources *</label>
          <textarea
            id="resources"
            pInputTextarea
            formControlName="resources"
            rows="6"
            placeholder="Describe resources to mobilize (e.g., volunteers, supplies, vehicles, etc.)"
          ></textarea>
        </div>
      </div>
    </form>

    <ng-template pTemplate="footer">
      <button
        pButton
        type="button"
        label="Cancel"
        icon="pi pi-times"
        class="p-button-secondary"
        (click)="showMobilizeDialog.set(false)"
      ></button>
      <button
        pButton
        type="button"
        label="Mobilize"
        icon="pi pi-check"
        class="p-button-warning"
        (click)="mobilizeResources()"
        [disabled]="mobilizeForm.invalid"
      ></button>
    </ng-template>
  </p-dialog>

  <!-- Resolve Crisis Dialog -->
  <p-dialog
    [(visible)]="showResolveDialog"
    (visibleChange)="showResolveDialog.set($event)"
    [header]="'Resolve Crisis'"
    [modal]="true"
    [style]="{ width: '500px' }"
  >
    <form [formGroup]="resolveForm">
      <div class="form-grid">
        <div class="form-field full-width">
          <label for="resolutionNotes">Resolution Notes *</label>
          <textarea
            id="resolutionNotes"
            pInputTextarea
            formControlName="resolutionNotes"
            rows="6"
            placeholder="Describe how the crisis was resolved..."
          ></textarea>
        </div>
      </div>
    </form>

    <ng-template pTemplate="footer">
      <button
        pButton
        type="button"
        label="Cancel"
        icon="pi pi-times"
        class="p-button-secondary"
        (click)="showResolveDialog.set(false)"
      ></button>
      <button
        pButton
        type="button"
        label="Resolve Crisis"
        icon="pi pi-check"
        class="p-button-success"
        (click)="resolveCrisis()"
        [disabled]="resolveForm.invalid"
      ></button>
    </ng-template>
  </p-dialog>

  <!-- Update Status Dialog -->
  <p-dialog
    [(visible)]="showUpdateStatusDialog"
    (visibleChange)="showUpdateStatusDialog.set($event)"
    [header]="'Update Status'"
    [modal]="true"
    [style]="{ width: '400px' }"
  >
    <form [formGroup]="updateStatusForm">
      <div class="form-grid">
        <div class="form-field full-width">
          <label for="update-status">New Status *</label>
          <p-dropdown
            id="update-status"
            [options]="statusOptions"
            formControlName="status"
            placeholder="Select new status"
            optionLabel="label"
            optionValue="value"
          ></p-dropdown>
        </div>
      </div>
    </form>

    <ng-template pTemplate="footer">
      <button
        pButton
        type="button"
        label="Cancel"
        icon="pi pi-times"
        class="p-button-secondary"
        (click)="showUpdateStatusDialog.set(false)"
      ></button>
      <button
        pButton
        type="button"
        label="Update"
        icon="pi pi-check"
        (click)="updateStatus()"
        [disabled]="updateStatusForm.invalid"
      ></button>
    </ng-template>
  </p-dialog>

  <!-- Add Affected Member Dialog -->
  <p-dialog
    [(visible)]="showAddMemberDialog"
    (visibleChange)="showAddMemberDialog.set($event)"
    [header]="'Add Affected Member'"
    [modal]="true"
    [style]="{ width: '500px' }"
  >
    <form [formGroup]="addMemberForm">
      <div class="form-grid">
        <div class="form-field full-width">
          <label for="memberId">Member ID *</label>
          <input
            type="number"
            id="memberId"
            pInputText
            formControlName="memberId"
            placeholder="Enter member ID"
          />
        </div>

        <div class="form-field full-width">
          <label for="member-notes">Notes</label>
          <textarea
            id="member-notes"
            pInputTextarea
            formControlName="notes"
            rows="3"
            placeholder="Additional notes about this affected member"
          ></textarea>
        </div>

        <div class="form-field checkbox-field full-width">
          <p-checkbox
            formControlName="isPrimaryContact"
            [binary]="true"
            inputId="isPrimaryContact"
          ></p-checkbox>
          <label for="isPrimaryContact">Primary Contact</label>
        </div>
      </div>
    </form>

    <ng-template pTemplate="footer">
      <button
        pButton
        type="button"
        label="Cancel"
        icon="pi pi-times"
        class="p-button-secondary"
        (click)="showAddMemberDialog.set(false)"
      ></button>
      <button
        pButton
        type="button"
        label="Add Member"
        icon="pi pi-check"
        (click)="addAffectedMember()"
        [disabled]="addMemberForm.invalid"
      ></button>
    </ng-template>
  </p-dialog>

  <!-- Manage Members Dialog -->
  <p-dialog
    [(visible)]="showManageMembersDialog"
    (visibleChange)="showManageMembersDialog.set($event)"
    [header]="'Manage Affected Members'"
    [modal]="true"
    [style]="{ width: '700px' }"
  >
    <div *ngIf="selectedCrisis()">
      <div class="dialog-actions" style="margin-bottom: 16px;">
        <button
          pButton
          type="button"
          label="Add Member"
          icon="pi pi-plus"
          class="p-button-sm"
          (click)="openAddMemberDialog(selectedCrisis()!)"
        ></button>
      </div>

      <p-table
        *ngIf="selectedCrisis()!.affectedMembers && selectedCrisis()!.affectedMembers!.length > 0"
        [value]="selectedCrisis()!.affectedMembers!"
        [paginator]="true"
        [rows]="5"
      >
        <ng-template pTemplate="header">
          <tr>
            <th>Member Name</th>
            <th>Notes</th>
            <th>Primary Contact</th>
            <th>Actions</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-member>
          <tr>
            <td>{{ member.memberName }}</td>
            <td>{{ member.notes || '-' }}</td>
            <td>
              <span *ngIf="member.isPrimaryContact" class="badge primary">
                <i class="pi pi-star"></i> Primary
              </span>
              <span *ngIf="!member.isPrimaryContact">-</span>
            </td>
            <td>
              <button
                pButton
                type="button"
                icon="pi pi-trash"
                class="p-button-text p-button-sm p-button-danger"
                (click)="removeAffectedMember(member.memberId)"
                pTooltip="Remove"
              ></button>
            </td>
          </tr>
        </ng-template>
      </p-table>

      <div *ngIf="!selectedCrisis()!.affectedMembers || selectedCrisis()!.affectedMembers!.length === 0" class="empty-members">
        <p>No affected members added yet</p>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <button
        pButton
        type="button"
        label="Close"
        icon="pi pi-times"
        (click)="showManageMembersDialog.set(false)"
      ></button>
    </ng-template>
  </p-dialog>
</div>
