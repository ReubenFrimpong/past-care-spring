<div class="prayer-requests-page">
  <p-toast></p-toast>
  <p-confirmDialog></p-confirmDialog>

  <!-- Page Header -->
  <div class="page-header">
    <h1>Prayer Requests</h1>
    <p class="subtitle">Manage and track prayer requests</p>
  </div>

  <!-- Statistics Cards -->
  <div class="stats-grid" *ngIf="stats()">
    <div class="stat-card">
      <div class="stat-icon total">
        <i class="pi pi-heart"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ stats()!.totalPrayerRequests }}</div>
        <div class="stat-label">Total Requests</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon pending">
        <i class="pi pi-clock"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ stats()!.pendingPrayerRequests }}</div>
        <div class="stat-label">Pending</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon active">
        <i class="pi pi-check-circle"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ stats()!.activePrayerRequests }}</div>
        <div class="stat-label">Active</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon answered">
        <i class="pi pi-verified"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ stats()!.answeredPrayerRequests }}</div>
        <div class="stat-label">Answered</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon urgent">
        <i class="pi pi-exclamation-triangle"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ stats()!.urgentPrayerRequests }}</div>
        <div class="stat-label">Urgent</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon public">
        <i class="pi pi-globe"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ stats()!.publicPrayerRequests }}</div>
        <div class="stat-label">Public</div>
      </div>
    </div>
  </div>

  <!-- Filters and Actions -->
  <div class="filters-section">
    <div class="filters">
      <span class="p-input-icon-left">
        <i class="pi pi-search"></i>
        <input
          type="text"
          pInputText
          placeholder="Search prayer requests..."
          [(ngModel)]="searchTerm"
          (ngModelChange)="searchTerm.set($event)"
        />
      </span>

      <p-dropdown
        [options]="statusOptions"
        [(ngModel)]="selectedStatus"
        (ngModelChange)="selectedStatus.set($event)"
        placeholder="Filter by Status"
        [showClear]="true"
        optionLabel="label"
        optionValue="value"
      ></p-dropdown>

      <p-dropdown
        [options]="categoryOptions"
        [(ngModel)]="selectedCategory"
        (ngModelChange)="selectedCategory.set($event)"
        placeholder="Filter by Category"
        [showClear]="true"
        optionLabel="label"
        optionValue="value"
      ></p-dropdown>

      <p-dropdown
        [options]="priorityOptions"
        [(ngModel)]="selectedPriority"
        (ngModelChange)="selectedPriority.set($event)"
        placeholder="Filter by Priority"
        [showClear]="true"
        optionLabel="label"
        optionValue="value"
      ></p-dropdown>

      <div class="checkbox-filter">
        <p-checkbox
          [(ngModel)]="showOnlyUrgent"
          (ngModelChange)="showOnlyUrgent.set($event)"
          [binary]="true"
          inputId="urgentOnly"
        ></p-checkbox>
        <label for="urgentOnly">Urgent Only</label>
      </div>

      <div class="checkbox-filter">
        <p-checkbox
          [(ngModel)]="showOnlyPublic"
          (ngModelChange)="showOnlyPublic.set($event)"
          [binary]="true"
          inputId="publicOnly"
        ></p-checkbox>
        <label for="publicOnly">Public Only</label>
      </div>

      <button
        pButton
        type="button"
        label="Clear Filters"
        icon="pi pi-filter-slash"
        class="p-button-secondary p-button-outlined"
        (click)="clearFilters()"
      ></button>
    </div>

    <button
      pButton
      type="button"
      label="New Prayer Request"
      icon="pi pi-plus"
      class="p-button-primary"
      (click)="openAddDialog()"
    ></button>
  </div>

  <!-- Prayer Requests Grid -->
  <div class="prayer-requests-grid" *ngIf="!loading()">
    <p-card *ngFor="let request of filteredPrayerRequests()" class="prayer-card">
      <div class="card-header">
        <div class="card-title">
          <i class="pi pi-heart-fill"></i>
          <span>{{ request.title }}</span>
        </div>
        <div class="card-actions">
          <button
            pButton
            type="button"
            icon="pi pi-eye"
            class="p-button-text p-button-sm"
            (click)="openViewDialog(request)"
            pTooltip="View Details"
          ></button>
          <button
            pButton
            type="button"
            icon="pi pi-pencil"
            class="p-button-text p-button-sm"
            (click)="openEditDialog(request)"
            pTooltip="Edit"
          ></button>
          <button
            pButton
            type="button"
            icon="pi pi-trash"
            class="p-button-text p-button-sm p-button-danger"
            (click)="deletePrayerRequest(request)"
            pTooltip="Delete"
          ></button>
        </div>
      </div>

      <div class="card-content">
        <div class="info-row" *ngIf="request.description">
          <p class="description">{{ request.description }}</p>
        </div>

        <div class="info-row">
          <span class="label">Requested By:</span>
          <span class="value">{{ request.isAnonymous ? 'Anonymous' : request.memberName }}</span>
        </div>

        <div class="info-row">
          <span class="label">Category:</span>
          <span class="value">{{ PrayerCategoryLabels[request.category] }}</span>
        </div>

        <div class="info-row" *ngIf="request.expirationDate">
          <span class="label">Expiration:</span>
          <span class="value" [class.expiring-soon]="isExpiringSoon(request)">
            {{ getExpirationText(request) }}
          </span>
        </div>

        <div class="badges-row">
          <span [class]="'status-badge ' + getStatusClass(request.status)">
            {{ PrayerRequestStatusLabels[request.status] }}
          </span>
          <span [class]="'priority-badge ' + getPriorityClass(request.priority)">
            {{ PrayerPriorityLabels[request.priority] }}
          </span>
          <span *ngIf="request.isAnonymous" class="badge anonymous">
            <i class="pi pi-eye-slash"></i> Anonymous
          </span>
          <span *ngIf="request.isUrgent" class="badge urgent">
            <i class="pi pi-exclamation-triangle"></i> Urgent
          </span>
          <span *ngIf="request.isPublic" class="badge public">
            <i class="pi pi-globe"></i> Public
          </span>
          <span *ngIf="!request.isPublic" class="badge private">
            <i class="pi pi-lock"></i> Private
          </span>
        </div>

        <div class="prayer-count">
          <i class="pi pi-heart-fill"></i>
          <span>{{ request.prayerCount }} {{ request.prayerCount === 1 ? 'prayer' : 'prayers' }}</span>
        </div>

        <div class="action-buttons">
          <button
            pButton
            type="button"
            label="Pray"
            icon="pi pi-heart"
            class="p-button-success p-button-sm pray-button"
            (click)="incrementPrayerCount(request)"
            [disabled]="request.status === PrayerRequestStatus.ARCHIVED"
          ></button>
          <button
            *ngIf="request.status !== PrayerRequestStatus.ANSWERED && request.status !== PrayerRequestStatus.ARCHIVED"
            pButton
            type="button"
            label="Mark as Answered"
            icon="pi pi-check"
            class="p-button-info p-button-sm"
            (click)="openAnswerDialog(request)"
          ></button>
          <button
            *ngIf="request.status !== PrayerRequestStatus.ARCHIVED"
            pButton
            type="button"
            label="Archive"
            icon="pi pi-folder"
            class="p-button-secondary p-button-sm"
            (click)="archivePrayerRequest(request)"
          ></button>
        </div>

        <div *ngIf="request.testimony" class="testimony-section">
          <div class="testimony-header">
            <i class="pi pi-verified"></i>
            <span>Testimony</span>
          </div>
          <p class="testimony-text">{{ request.testimony }}</p>
        </div>
      </div>
    </p-card>

    <div *ngIf="filteredPrayerRequests().length === 0" class="empty-state">
      <i class="pi pi-heart"></i>
      <p>No prayer requests found</p>
      <button
        pButton
        type="button"
        label="Create First Prayer Request"
        icon="pi pi-plus"
        (click)="openAddDialog()"
      ></button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading()" class="loading-state">
    <i class="pi pi-spin pi-spinner"></i>
    <p>Loading prayer requests...</p>
  </div>

  <!-- Add Dialog -->
  <p-dialog
    [(visible)]="showAddDialog"
    (visibleChange)="showAddDialog.set($event)"
    [header]="'New Prayer Request'"
    [modal]="true"
    [style]="{ width: '600px' }"
  >
    <form [formGroup]="prayerRequestForm">
      <div class="form-grid">
        <div class="form-field">
          <label for="memberId">Member ID *</label>
          <input
            type="number"
            id="memberId"
            pInputText
            formControlName="memberId"
            placeholder="Enter member ID"
          />
        </div>

        <div class="form-field">
          <label for="category">Category *</label>
          <p-dropdown
            id="category"
            [options]="categoryOptions"
            formControlName="category"
            placeholder="Select category"
            optionLabel="label"
            optionValue="value"
          ></p-dropdown>
        </div>

        <div class="form-field full-width">
          <label for="title">Title *</label>
          <input
            type="text"
            id="title"
            pInputText
            formControlName="title"
            placeholder="Enter prayer request title"
          />
        </div>

        <div class="form-field full-width">
          <label for="description">Description</label>
          <textarea
            id="description"
            pInputTextarea
            formControlName="description"
            rows="4"
            placeholder="Enter prayer request details"
          ></textarea>
        </div>

        <div class="form-field">
          <label for="priority">Priority *</label>
          <p-dropdown
            id="priority"
            [options]="priorityOptions"
            formControlName="priority"
            placeholder="Select priority"
            optionLabel="label"
            optionValue="value"
          ></p-dropdown>
        </div>

        <div class="form-field">
          <label for="status">Status *</label>
          <p-dropdown
            id="status"
            [options]="statusOptions"
            formControlName="status"
            placeholder="Select status"
            optionLabel="label"
            optionValue="value"
          ></p-dropdown>
        </div>

        <div class="form-field">
          <label for="expirationDate">Expiration Date</label>
          <p-calendar
            id="expirationDate"
            formControlName="expirationDate"
            [showIcon]="true"
            dateFormat="yy-mm-dd"
          ></p-calendar>
        </div>

        <div class="form-field">
          <label for="tags">Tags</label>
          <input
            type="text"
            id="tags"
            pInputText
            formControlName="tags"
            placeholder="Comma-separated tags"
          />
        </div>

        <div class="form-field checkbox-field">
          <p-checkbox
            formControlName="isAnonymous"
            [binary]="true"
            inputId="isAnonymous"
          ></p-checkbox>
          <label for="isAnonymous">Anonymous Request</label>
        </div>

        <div class="form-field checkbox-field">
          <p-checkbox
            formControlName="isUrgent"
            [binary]="true"
            inputId="isUrgent"
          ></p-checkbox>
          <label for="isUrgent">Mark as Urgent</label>
        </div>

        <div class="form-field checkbox-field">
          <p-checkbox
            formControlName="isPublic"
            [binary]="true"
            inputId="isPublic"
          ></p-checkbox>
          <label for="isPublic">Public Request</label>
        </div>
      </div>
    </form>

    <ng-template pTemplate="footer">
      <button
        pButton
        type="button"
        label="Cancel"
        icon="pi pi-times"
        class="p-button-secondary"
        (click)="showAddDialog.set(false)"
      ></button>
      <button
        pButton
        type="button"
        label="Save"
        icon="pi pi-check"
        (click)="savePrayerRequest()"
        [disabled]="prayerRequestForm.invalid"
      ></button>
    </ng-template>
  </p-dialog>

  <!-- Edit Dialog -->
  <p-dialog
    [(visible)]="showEditDialog"
    (visibleChange)="showEditDialog.set($event)"
    [header]="'Edit Prayer Request'"
    [modal]="true"
    [style]="{ width: '600px' }"
  >
    <form [formGroup]="prayerRequestForm">
      <div class="form-grid">
        <div class="form-field">
          <label for="edit-memberId">Member ID *</label>
          <input
            type="number"
            id="edit-memberId"
            pInputText
            formControlName="memberId"
          />
        </div>

        <div class="form-field">
          <label for="edit-category">Category *</label>
          <p-dropdown
            id="edit-category"
            [options]="categoryOptions"
            formControlName="category"
            optionLabel="label"
            optionValue="value"
          ></p-dropdown>
        </div>

        <div class="form-field full-width">
          <label for="edit-title">Title *</label>
          <input
            type="text"
            id="edit-title"
            pInputText
            formControlName="title"
          />
        </div>

        <div class="form-field full-width">
          <label for="edit-description">Description</label>
          <textarea
            id="edit-description"
            pInputTextarea
            formControlName="description"
            rows="4"
          ></textarea>
        </div>

        <div class="form-field">
          <label for="edit-priority">Priority *</label>
          <p-dropdown
            id="edit-priority"
            [options]="priorityOptions"
            formControlName="priority"
            optionLabel="label"
            optionValue="value"
          ></p-dropdown>
        </div>

        <div class="form-field">
          <label for="edit-status">Status *</label>
          <p-dropdown
            id="edit-status"
            [options]="statusOptions"
            formControlName="status"
            optionLabel="label"
            optionValue="value"
          ></p-dropdown>
        </div>

        <div class="form-field">
          <label for="edit-expirationDate">Expiration Date</label>
          <p-calendar
            id="edit-expirationDate"
            formControlName="expirationDate"
            [showIcon]="true"
            dateFormat="yy-mm-dd"
          ></p-calendar>
        </div>

        <div class="form-field">
          <label for="edit-tags">Tags</label>
          <input
            type="text"
            id="edit-tags"
            pInputText
            formControlName="tags"
          />
        </div>

        <div class="form-field checkbox-field">
          <p-checkbox
            formControlName="isAnonymous"
            [binary]="true"
            inputId="edit-isAnonymous"
          ></p-checkbox>
          <label for="edit-isAnonymous">Anonymous Request</label>
        </div>

        <div class="form-field checkbox-field">
          <p-checkbox
            formControlName="isUrgent"
            [binary]="true"
            inputId="edit-isUrgent"
          ></p-checkbox>
          <label for="edit-isUrgent">Mark as Urgent</label>
        </div>

        <div class="form-field checkbox-field">
          <p-checkbox
            formControlName="isPublic"
            [binary]="true"
            inputId="edit-isPublic"
          ></p-checkbox>
          <label for="edit-isPublic">Public Request</label>
        </div>
      </div>
    </form>

    <ng-template pTemplate="footer">
      <button
        pButton
        type="button"
        label="Cancel"
        icon="pi pi-times"
        class="p-button-secondary"
        (click)="showEditDialog.set(false)"
      ></button>
      <button
        pButton
        type="button"
        label="Update"
        icon="pi pi-check"
        (click)="updatePrayerRequest()"
        [disabled]="prayerRequestForm.invalid"
      ></button>
    </ng-template>
  </p-dialog>

  <!-- View Dialog -->
  <p-dialog
    [(visible)]="showViewDialog"
    (visibleChange)="showViewDialog.set($event)"
    [header]="'Prayer Request Details'"
    [modal]="true"
    [style]="{ width: '600px' }"
  >
    <div *ngIf="selectedPrayerRequest()" class="view-content">
      <div class="detail-row">
        <span class="detail-label">Title:</span>
        <span class="detail-value">{{ selectedPrayerRequest()!.title }}</span>
      </div>

      <div class="detail-row" *ngIf="selectedPrayerRequest()!.description">
        <span class="detail-label">Description:</span>
        <span class="detail-value">{{ selectedPrayerRequest()!.description }}</span>
      </div>

      <div class="detail-row">
        <span class="detail-label">Requested By:</span>
        <span class="detail-value">
          {{ selectedPrayerRequest()!.isAnonymous ? 'Anonymous' : selectedPrayerRequest()!.memberName }}
        </span>
      </div>

      <div class="detail-row">
        <span class="detail-label">Category:</span>
        <span class="detail-value">{{ PrayerCategoryLabels[selectedPrayerRequest()!.category] }}</span>
      </div>

      <div class="detail-row">
        <span class="detail-label">Priority:</span>
        <span [class]="'priority-badge ' + getPriorityClass(selectedPrayerRequest()!.priority)">
          {{ PrayerPriorityLabels[selectedPrayerRequest()!.priority] }}
        </span>
      </div>

      <div class="detail-row">
        <span class="detail-label">Status:</span>
        <span [class]="'status-badge ' + getStatusClass(selectedPrayerRequest()!.status)">
          {{ PrayerRequestStatusLabels[selectedPrayerRequest()!.status] }}
        </span>
      </div>

      <div class="detail-row">
        <span class="detail-label">Prayer Count:</span>
        <span class="detail-value">
          <i class="pi pi-heart-fill"></i>
          {{ selectedPrayerRequest()!.prayerCount }}
        </span>
      </div>

      <div class="detail-row" *ngIf="selectedPrayerRequest()!.expirationDate">
        <span class="detail-label">Expiration:</span>
        <span class="detail-value">{{ selectedPrayerRequest()!.expirationDate | date: 'MMM d, y' }}</span>
      </div>

      <div class="detail-row" *ngIf="selectedPrayerRequest()!.answeredDate">
        <span class="detail-label">Answered On:</span>
        <span class="detail-value">{{ selectedPrayerRequest()!.answeredDate | date: 'MMM d, y' }}</span>
      </div>

      <div class="detail-row" *ngIf="selectedPrayerRequest()!.testimony">
        <span class="detail-label">Testimony:</span>
        <span class="detail-value">{{ selectedPrayerRequest()!.testimony }}</span>
      </div>

      <div class="detail-row" *ngIf="selectedPrayerRequest()!.tags">
        <span class="detail-label">Tags:</span>
        <span class="detail-value">{{ selectedPrayerRequest()!.tags }}</span>
      </div>

      <div class="detail-row">
        <span class="detail-label">Visibility:</span>
        <span class="detail-value">
          {{ selectedPrayerRequest()!.isPublic ? 'Public' : 'Private' }}
        </span>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <button
        pButton
        type="button"
        label="Close"
        icon="pi pi-times"
        (click)="showViewDialog.set(false)"
      ></button>
    </ng-template>
  </p-dialog>

  <!-- Mark as Answered Dialog -->
  <p-dialog
    [(visible)]="showAnswerDialog"
    (visibleChange)="showAnswerDialog.set($event)"
    [header]="'Mark as Answered'"
    [modal]="true"
    [style]="{ width: '500px' }"
  >
    <form [formGroup]="answerForm">
      <div class="form-grid">
        <div class="form-field full-width">
          <label for="testimony">Testimony *</label>
          <textarea
            id="testimony"
            pInputTextarea
            formControlName="testimony"
            rows="6"
            placeholder="Share how this prayer was answered..."
          ></textarea>
        </div>
      </div>
    </form>

    <ng-template pTemplate="footer">
      <button
        pButton
        type="button"
        label="Cancel"
        icon="pi pi-times"
        class="p-button-secondary"
        (click)="showAnswerDialog.set(false)"
      ></button>
      <button
        pButton
        type="button"
        label="Mark as Answered"
        icon="pi pi-check"
        class="p-button-success"
        (click)="markAsAnswered()"
        [disabled]="answerForm.invalid"
      ></button>
    </ng-template>
  </p-dialog>
</div>
